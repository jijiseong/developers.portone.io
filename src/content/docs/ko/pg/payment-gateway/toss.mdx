---
title: 토스페이먼츠
description: 토스페이먼츠 (신모듈 / 2022-07-27 버전) 연동 방법을 확인합니다.
targetVersions: ["v1"]
---

import Figure from "~/components/Figure.astro";
import Codepen from "~/components/gitbook/Codepen.astro";
import Details from "~/components/gitbook/Details.astro";
import Tab from "~/components/gitbook/tabs/Tab.astro";
import Tabs from "~/components/gitbook/tabs/Tabs.astro";
import Hint from "~/components/Hint.astro";

import screenshot2 from "./_assets/toss-brandpay/loadui.png";
import screenshot3 from "./_assets/toss-brandpay/updateloadui.png";
import screenshot1 from "./_assets/toss-brandpay/widget_example.png";
import image1 from "./_assets/tosspayments/tosspayments1.webp";
import image2 from "./_assets/tosspayments/tosspayments2.png";
import image3 from "./_assets/tosspayments/tosspayments3.png";
import image4 from "./_assets/tosspayments/tosspayments4.png";

<Hint style="info">
  [토스페이먼츠(구모듈) 연동 가이드 바로가기](#토스페이먼츠구모듈-연동-가이드)
</Hint>

<Hint style="info">
  [토스페이먼츠 브랜드페이 연동 가이드 바로가기](#토스페이먼츠-브랜드페이-연동-가이드)
</Hint>

## 1. 토스페이먼츠(신모듈) 채널 설정하기

[결제대행사 채널 설정하기](../../ready/readme#3-결제대행사-채널-설정하기) 페이지의 내용을 참고하여 채널 설정을 진행합니다.

<Figure src={image1} />

## 2. 최신 JavaScript SDK로 업데이트하기

토스페이먼츠 신모듈 결제는 최신 SDK에서만 지원되는 기능입니다.

```html title="JS SDK"
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
```

<Hint style="info">
  **토스페이먼츠 신모듈을 연동하기 위해서는 위에 안내된 JS SDK를 이용하셔야 합니다**
</Hint>

[JavaScript SDK](../../sdk/javascript-sdk/readme)문서를 통해 최신 SDK를 설치해주세요.

## 3. 결제 요청하기

신규 SDK가 제공하는 `IMP` 모듈에서 `request_pay` 함수를 호출합니다.

`pg` 파라미터를 `tosspayments`로 지정하여 토스페이먼츠 신 모듈 연동임을 명시해주세요.

토스페이먼츠 신 모듈을 기준으로 작성한 예시 코드는 아래와 같습니다.

<Tabs>
  <Tab title="인증결제창 요청">
    ```ts showLineNumbers
    const userCode = "고객사 식별코드";
    IMP.init(userCode); // 고객사 식별 코드를 넣어 모듈을 초기화해주세요.

    IMP.request_pay(
      {
        pg: "tosspayments", // 반드시 "tosspayments"임을 명시해주세요.
        merchant_uid: "order_id_1667634130160",
        name: "나이키 와플 트레이너 2 SD",
        pay_method: "card",
        escrow: false,
        amount: "109000",
        tax_free: 3000,
        buyer_name: "홍길동",
        buyer_email: "buyer@example.com",
        buyer_tel: "02-1670-5176",
        buyer_addr: "성수이로 20길 16",
        buyer_postcode: "04783",
        m_redirect_url: "https://helloworld.com/payments/result", // 모바일 환경에서 필수 입력
        notice_url: "https://helloworld.com/api/v1/payments/notice",
        confirm_url: "https://helloworld.com/api/v1/payments/confirm",
        currency: "KRW",
        locale: "ko",
        custom_data: { userId: 30930 },
        display: { card_quota: [0, 6] },
        appCard: false,
        useCardPoint: true,
        bypass: {
          tosspayments: {
            useInternationalCardOnly: true, // 영어 결제창 활성화
          },
        },
      },
      (response) => {
        // PC 환경에서 결제 프로세스 완료 후 실행 될 로직
      },
    );
    ```

    <Details>
      <p slot="summary"><strong>주요 파라미터 설명</strong></p>

      **`pg` \***<mark style="color:green;">**string**</mark>

      **PG사 구분코드**

      _tosspayments_ 로 지정하면 됩니다.

      **`pay_method`** <mark style="color:green;">**string**</mark>

      - 카드 (card)
      - 계좌이체(trans)
      - 가상계좌(vbank)
      - 휴대폰 소액결제(phone)
      - 도서문화상품권(booknlife)
      - 스마트문상(smartculture)
      - 컬쳐랜드(cultureland)
      - 카카오페이 (kakaopay)
      - 네이버페이 (naverpay)
      - 엘페이 (lpay)
      - 삼성페이(samsung)
      - SSGpay (ssgpay)
      - 애플페이 (applepay)
      - 페이코 (payco)
      - 토스간편결제 (tosspay)

      **`merchant_uid`** <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>

      **주문번호**

      매번 고유하게 채번되어야 합니다.

      **`amount` \***<mark style="color:purple;">**number**</mark>

      **결제금액**

      <mark style="color:green;">**string**</mark> 이 아닌점에 유의하세요

      **`buyer_name`** <mark style="color:red;">**\***</mark> <mark style="color:green;">**`string`**</mark>

      **`구매자 이름`**

      **`buyer_email`** <mark style="color:green;">**`string`**</mark>

      **`구매자 email 주소`**

      **`currency`** <mark style="color:green;">**`string`**</mark>

      **`통화구분코드`**

      **`appCard`** <mark style="color:orange;">**`boolean`**</mark>

      카드 결제시, 카드 결제창에 앱카드만 선택 가능하도록 할지 여부 (기본값: **false**)

      **`useCardPoint`** <mark style="color:orange;">**`boolean`**</mark>

      카드 결제시, 카드 포인트 사용 허용할지 여부
    </Details>

    <Details>
      <p slot="summary">기타 <strong>파라미터 설명</strong></p>

      **`bypass`** <mark style="color:purple;">**object**</mark>

      **`isCulturalExpense`** <mark style="color:orange;">**boolean**</mark>

      문화비 지출여부

      **`useInternationalCardOnly`** <mark style="color:orange;">**boolean**</mark>

      해외카드(Visa, MasterCard, UnionPay) 결제 여부입니다. 값이 `true`면 해외카드 결제가 가능한 영문 결제창이 열립니다.

      **`cashReceiptType`** <mark style="color:green;">**string**</mark>

      현금성 결제(계좌이체, 가상계좌)창에서 선택할 수 있는 현금영수증 발급 유형 (기본값: 결제창에서 선택 가능)

      - anonymous (미발행, 자진발급)
      - personal (소득공제)
      - corporate (지출증빙)

      ```json
      {
        "pay_method": "trans",
        "bypass": {
          "isCulturalExpense": true,
          "cashReceiptType": "personal"
        }
      }
      ```
    </Details>
  </Tab>

  <Tab title="비인증 결제창 요청">
    인증결제창 호출 파라미터에서 **customer\_uid** 값을 추가하면 비 인증 결제창을 호출할 수 있습니다. 비 인증 결제창에서 빌링키를 발급받은 후 해당 빌링키로 결제를 요청합니다.

    ```ts title="Javascript SDK"
    IMP.request_pay(
      {
        pg: "tosspayments.{MID}",
        pay_method: "card", // 'card'만 지원됩니다.
        merchant_uid: "order_monthly_0001", // 상점에서 관리하는 주문 번호
        name: "최초인증결제",
        amount: 0, // 실제 승인은 발생되지 않고 오직 빌링키만 발급됩니다.
        customer_uid: "your-customer-unique-id", // 필수 입력.
        buyer_email: "test@portone.io",
        buyer_name: "포트원",
        buyer_tel: "02-1234-1234",
        m_redirect_url: "{모바일에서 결제 완료 후 리디렉션 될 URL}",
        customer_id: "matthew", //고객사가 회원에게 부여한 고유 ID
      },
      function (rsp) {
        // callback 로직
      },
    );
    ```

    <Hint style="info">
      - 비인증 결제를 위해서는 **토스페이먼츠로 부터 발급받은 MID정보**를 포트원 관리자콘솔에 설정하셔야 비 인증 결제창을 활성화 시킬수 있습니다.
      - 빌링키 발급시 <mark style="color:red;">**실 결제는 발생되지 않습니다**</mark>.(금액을 지정해도 결제가 발생되지 않음)
    </Hint>

    **주요 파라미터 설명**

    **`pg` \***<mark style="color:green;">**string**</mark>

    **PG사 구분코드**

    **`tosspayments`** 로 지정하면 됩니다.

    **`customer_uid` \***<mark style="color:green;">**string**</mark>

    **카드 빌링키**

    비 인증 결제창에서 고객이 입력한 카드정보와 1:1로 매칭될 빌링키를 지정합니다.

    **`amount` \***<mark style="color:purple;">**number**</mark>

    **결제금액**

    결제창에 표시될 금액으로 <mark style="color:red;">실제 승인은 이루어지지 않습니다.</mark>(실 결제를 발생시키기 위해서는 **customer\_uid** 로 **REST API 를 이용하여 결제요청**을 해주셔야 합니다.)

    **`customer_id`** <mark style="color:green;">**`string`**</mark>

    **`구매자 식별자`**

    빌링키를 발급한 고객의 고유 ID 를 지정합니다.(회원ID) 해당 값 설정시 빌링키와 고객을 맵핑할 수 있습니다. 누락시 포트원에서 임의의 값을 설정합니다.

    **빌링키(customer\_uid)로 결제 요청하기**

    빌링키 발급이 성공하면 실 빌링키는 customer\_uid 와 1:1 매칭되어 **포트원 서버에 저장**됩니다. customer\_uid를 고객사 내부서버에 저장하시고 [<mark style="color:blue;">**비 인증 결제요청 REST API**</mark>](../../api/api-4/api)를 호출하시면 결제를 발생시킬 수 있습니다.

    ```sh title="server-side"
    curl -H "Content-Type: application/json" \
         -X POST -d '{"customer_uid":"your-customer-unique-id", "merchant_uid":"order_id_8237352", "amount":3000}' \
         https://api.iamport.kr/subscribe/payments/again
    ```
  </Tab>

  <Tab title="비인증 API 방식">
    **API 방식으로 빌링키 발급,결제요청,예약결제를 구현할수 있습니다.**

    <Hint style="danger">
      **MID 발급시 주의사항**

      토스페이먼츠로 부터 MID 발급시 <mark style="color:red;">**API version**</mark> 은 반드시 <mark style="color:red;">**1.4**</mark> 이어야 합니다.
    </Hint>

    **일회성 결제 요청하기**

    [**REST API POST /subscribe/payments/onetime**](../../api/api-4/api-1)을 호출하여 일회성 결제를 요청합니다. 요청 시 전달된 카드는 포트원에 등록되지 않습니다.

    ```sh
    curl -H "Content-Type: application/json" \
         -X POST -d '{"merchant_uid":"order_id_8237352", "card_number":"1234-1234-1234-1234", "expiry":"2019-01", "birth":"123456", "amount":3000}' \
         https://api.iamport.kr/subscribe/payments/onetime
    ```

    **빌링키 발급 요청하기**

    REST [**API POST /subscribe/customers/\{customer\_uid}**](../../api/api-2/api-1)를 호출하여 빌링키 발급을 요청합니다.

    ```sh
    curl -H "Content-Type: application/json" \
         -X POST -d '{"card_number":"1234-1234-1234-1234", "expiry":"2025-12", "birth":"820213", "pwd_2digit":"00"}' \
         https://api.iamport.kr/subscribe/customers/your-customer-unique-id
    ```

    **빌링키 발급 및 최초 결제 요청하기**

    REST [**API POST /subscribe/payments/onetime**](../../api/api-4/api-1)을 호출하여 빌링키 발급과 최초 결제를 요청합니다.

    - **`customer_uid`** : 빌링키 등록을 위해서 지정해야 합니다.

    ```sh
    curl -H "Content-Type: application/json" \
         -X POST -d '{"customer_uid":"your-customer-unique-id", "merchant_uid":"order_id_8237352", "card_number":"1234-1234-1234-1234", "expiry":"2019-01", "birth":"123456", "amount":3000}' \
         https://api.iamport.kr/subscribe/payments/onetime
    ```

    **빌링키로 결제 요청하기**

    빌링키 발급과 최초 결제가 성공하면 빌링키는 전달된 `customer_uid` 와 1:1 매칭되어 포트원에 저장됩니다. 보안상의 이유로 서버는 빌링키에 직접 접근할 수 없기 때문에 `customer_uid`를 이용해서 재결제([**POST /subscribe/payments/again**](../../api/api-4/api)) REST API를 다음과 같이 호출합니다.

    ```sh
    curl -H "Content-Type: application/json" \
         -X POST -d '{"customer_uid":"your-customer-unique-id", "merchant_uid":"order_id_8237352", "amount":3000}' \
         https://api.iamport.kr/subscribe/payments/again
    ```
  </Tab>
</Tabs>

## 4. 부가기능

<Tabs>
  <Tab title="할부개월수 설정">
    ```json title="javascript"
    {
      "display": {
        "card_quota": [6],  // 할부개월 6개월만 활성화
        "only_installment": true  // 일시불 항목은 제외
      }
    }
    ```

    **파라미터 설명**

    - **card\_quota :**

    \- 지정한 숫자에 해당하는 할부개월수만 표기

    \- `[]`: 일시불만 결제 가능

    \- `2,3,4,5,6`: 일시불을 포함한 2, 3, 4, 5, 6개월까지 할부개월 선택 가능\\

    - **`only_installment` : `true`** 인 경우 `card_quota` 에 설정한 할부개월수만 표시

    <Hint style="info">
      할부결제는 **5만원 이상 결제 요청시**에만 이용 가능합니다.
    </Hint>
  </Tab>

  <Tab title="카드사 모듈 바로 호출">
    ```json title="javascript"
    {
      "card": {
        "direct": {
          "code": "367",
          "quota": 3
        }
      }
    }
    ```

    **파라미터 설명**

    - **`code`** : 카드사 금융결제원 표준 코드. [<mark style="color:red;">**링크**</mark>](https://faq.portone.io/6503bcb4-4a61-4cf3-afd8-5d913b1385a6) 참조 (**string**)
    - **`quota`** : 할부 개월 수. 일시불일 시 0 으로 지정. (**number**)
  </Tab>

  <Tab title="고정식 가상계좌 발급">
    토스페이먼츠 고정식 가상계좌 발급 서비스를 이용하기 위해서는 **토스페이먼츠 측과 협의**를 통해 결제에 이용하는 MID에 고정식 가상계좌 설정이 반드시 선행되어야 합니다.

    해당 설정이 완료되면 두가지 방식으로 고정식 가상계좌를 발급할 수 있습니다.

    - [API 방식](../../api/api-9/api)
    - 결제창 방식

    두 방식 모두 **고유식별번호**가 유입되어야 하며 해당 값은 각 고객을 특정할수 있는 고유값이어야 합니다.

    결제창 방식을 이용하기 위해서 고객에게 사전에 해당 고유식별번호가 안내되어야 하며 가상계좌 발급단계에서 아래 첨부이미지처럼 고유식별번호 란에 해당 값이 유입되어야 합니다.

    <Figure src={image2} />

    API 방식 또한 `vbank_key` 파라미터가 고유식별번호에 대응되는 값으로 API방식은 고객사에서 직접 해당 값을 기재해서 호출할수 있기 때문에 고객 편의차원에서 훨씬 간편한 고정식 가상계좌 서비스를 제공할수 있습니다.

    고정식 가상계좌 발급이 정상적으로 이루어지면 아래와 같이 고객휴대폰 번호로 SMS가 발송되며 고객은 해당 정보를 보고 입금을 할수 있습니다.(비용: 무료)

    <Figure src={image3} />
  </Tab>
</Tabs>

## 5. 사용가능 기능

토스페이먼츠 신모듈을 통해서 사용가능한 추가 기능들은 다음과 같습니다. 자세한 내용은 API 문서를 참고해주세요.

- [결제금액 사전등록 API](../../api/api-1/api-5)
- [결제취소 API](../../api/api-1/api)
- [현금영수증 API](../../api/api-8/readme)
- [현금영수증 발급(외부) API](../../api/api-8/api-5)

<Hint style="danger">
  **기존에 deprecated된 응답들은 모두 제거됐습니다. ⚠️**

  신 토스페이먼츠 모듈 연동시에 사용되는 신규 JS SDK는 기존 모듈에서 제공했던 CallBack 파라미터가 대부분 삭제되었습니다.(특히 deprecated 로 명시된 파라미터는 모두 삭제되었습니다.)

  해당 JS SDK 사용시 Callback 으로 내려받을수 있는 데이터는 오직 아래 두가지 입니다.

  **`imp_uid`, `merchant_uid`**

  따라서 해당 SDK를 사용하실때는 `IMP.request_pay()`로부터 응답된 객체(또는 쿼리 파라미터)에서 `imp_uid`를 가지고 **아임포트 REST API(GET `/payments/imp_uid`)로 결제 상세 내역(승인 상태, 승인 결과 등등)을 조회**하여 응답 파라미터 중 status 파라미터로 결제 상태를 파악하셔야 합니다.
</Hint>

<Hint style="info">
  ```html
  <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
  ```

  위 JS SDK 를 이용하여 토스페이먼츠,케이에스넷 연동시 callback Data는
  아래와 같이 두가지 형태로만 내려갑니다.

  - `imp_uid`
  - `merchant_uid`

  위 PG사를 제외한 다른 PG사는 `imp_success` 파라미터가 기존처럼 내려가지만
  해당 파리미터는 deprecated 된 값이기 때문에 해당 값에 의존성을 가진 프로그램 로직은 모두 삭제하시는
  방향성을 잡아가셔야 하는점 유념하시기 바랍니다.
</Hint>

<Hint style="info">
  **토스페이먼츠 API 버전 설정**

  - [토스페이먼츠 개발자센터](https://app.tosspayments.com/signin?redirectUrl=https%3A%2F%2Fdevelopers.tosspayments.com%2Fmy%2Fapi-keys) 로그인

  - 왼쪽 네비게이션 메뉴 API 키 선택 → API 버전을 **2022-07-27**로 선택

    API 버전을 다르게 설정하면 결제 승인 / 실패 시 실제 응답과 다른 응답을 받아볼 수 있으니 **반드시 API 버전을 2022-07-27로** 맞춰주시기 바랍니다

  <Figure src={image4} />
</Hint>

## 토스페이먼츠 (신 모듈) 연동 유의사항

## 토스페이먼츠와 사전 계약이 필요한 경우

아래 기능을 사용하시려면 토스페이먼츠에 사전 신청 후 계약이 완료되어야 합니다.

계약 하지 않은 경우 해당 기능 이용시 결제 승인에 실패하거나, 승인에 성공하더라도 의도한 바와는 다른
응답(결제창에서 에스크로 결제를 했으나 비-에스크로 결제 응답을 받음)을 얻게 될 수 있습니다.

- 간편결제 사용
- 면세 / 복합과세 사용
- 할부 사용
- 상점 부담 무이자 할부 사용
- 상품권 결제 사용
- 카드사 포인트 사용
- 에스크로 사용

## 카드 결제

<Details>
  <p slot="summary">appCard 파라미터는 일부 카드사에 대해서만 적용 됨</p>

  토스페이먼츠의 경우 카드 결제시, 앱 카드로만 결제할 수 있도록 제한하는 appCard 파라미터를 지원하지만 지원 범위가 아래와 같이 제한적입니다.

  - 지원 가능 카드: 국민, 농협, 롯데, 삼성, 신한, 현대, 우리, 하나
  - 지원 불가 카드: 씨티
</Details>

<Details>
  <p slot="summary">display.card\_quota 파라미터는 다른 PG사와 다르게 동작 함</p>

  display.card\_quota 파라미터로 결제창에 렌더링 될 할부 개월수 리스트를 제어할 수 있습니다. 다른 PG사는 전달한 값만 렌더링 되지만, 토스페이먼츠의 경우에는 토스페이먼츠 자체 정책에 따라 **일시불 \~ 전달한 값 중 최대값까지 모두 렌더링**됩니다.

  - 예1. 일시불만 허용

    ```json
    {
      "display": {
        "card_quota": [0]
      }
    }
    ```

  - 예2. 5개월만 허용

    ```json
    {
      "display": {
        "card_quota": [5]
      }
    }
    ```

  - 예3. \[토스페이먼츠] 일시불 \~ 5개월까지 허용

    ```json
    {
      "display": {
        "card_quota": [3, 5] // 3과 5 중에 최대값이 5이기 때문에 일시불 ~ 5개월까지 모두 렌더링 된다
      }
    }
    ```

  - 예3. \[타 PG사] 일시불 \~ 5개월까지 허용

    ```json
    {
      "display": {
        "card_quota": [0, 1, 2, 3, 4, 5]
      }
    }
    ```

  - 예4. \[토스페이먼츠] 3개월과 5개월만 허용 → **불가능**

  - 예5. \[타 PG사] 3개월과 5개월만 허용
</Details>

<Details>
  <p slot="summary">무이자 할부가 적용 되어도 ISP 계열 카드로 결제시에는 “무이자” 표기가 되지 않음</p>

  고객사는 토스페이먼츠와 사전 계약 또는 카드사 정책에 따라 무이자 할부 기능을 사용할 수 있습니다. 이에 따라 결제창 내에서 각 카드 사별 최대 무이자 할부 개월수에 따라 할부 개월수 옆에 “무이자” 또는 “무”라고 표기 됩니다.

  - 예1. 삼성카드 - 최대 3개월 무이자 할부 적용 → 3개월까지 “무” 표기

    <Figure src="/gitbook-assets/ko/image (176).png" />

  하지만 ISP 계열 카드의 경우에는 실제로 무이자가 적용된다고 하더라도 “무이자” 여부가 표기되지 않습니다.

  - 예2. BC카드 - 최대 12개월 무이자 할부 적용 → 표기 없음 → 실제 결제 승인시 무이자 할부 적용은 됨

    <Figure src="/gitbook-assets/ko/image (185).png" />

  이는 ISP 계열 카드사 결제시 사용되는 페이북 앱 특성에 따른 것으로 실제 결제 승인시에는 정상적으로 무이자 할부가 적용됩니다.
</Details>

<Details>
  <p slot="summary">할부 기간 선택 관련 이슈</p>

  모바일 웹 - 카드 결제시 토스페이먼츠 결제창 내에서 간편결제의 경우 할부 기간 선택이 불가능하고, 간편결제 외의 모든 카드사의 경우엔 할부 기간 선택이 가능합니다.

  - 모바일 웹 - 간편결제 외 카드사: 할부 기간 선택 가능\
    ![](</gitbook-assets/ko/image (178).png>)

  - 모바일 웹 - 간편결제: 할부 기간 선택 불가능\
    ![](</gitbook-assets/ko/image (351).png>)

  반면, PC - 카드 결제 - ISP계열의 경우에는 토스페이먼츠 결제창 내에서도 할부 기간 선택이 불가능 하며, 대신 ISP 페이북 팝업에서는 선택이 가능합니다.

  - PC - 카드결제 - ISP 선택: 할부 기간 선택 불가능
    <img src="/gitbook-assets/ko/image (184).png" alt="" data-size="original" />

  - PC - 카드결제 - ISP 선택 - 페이북 팝업: 할부 기간 선택 가능

  다소 헷갈릴 수 있으나 간편결제는 간편결제 앱에서 할부 개월수를 선택할 수 있어 토스페이먼츠 결제창에서 선택할 수 없다는 토스 답변이 있었습니다.
</Details>

<Details>
  <p slot="summary">카카오페이 13개월 이상 할부 개월수 불가능한 이슈</p>

  카카오페이 자체에서 13개월 이상 할부 결제를 지원하지 않기 때문에, 카카오페이로는 최대 12개월까지 할부 결제가 가능합니다.
</Details>

<Details>
  <p slot="summary">카카오페이 일부 카드의 경우 카드 정보를 확인할 수 없는 이슈</p>

  카카오페이로 결제시 일부 카드(2022년 6월 이후 카드사 측에서 신규 생성 된 카드)의 경우, 카카오페이 → 토스페이먼츠로 카드 정보를 정상적으로 내려주지 않기 때문에 포트원 REST API로 결제내역 조회(GET /payments/\{imp\_uid})시 카드사 정보(card\_code: 카드 코드, card\_name: 카드 이름)를 확인할 수 없습니다.
</Details>

## 카드사 다이렉트 호출

<Details>
  <p slot="summary">고정 할부 개월수(card.direct.quota)를 보내지 않으면 무조건 일시불로 결제 됨</p>

  토스페이먼츠는 카드사 다이렉트 호출시 **quota 값을 전달하지 않는 경우에는 무조건 일시불로 결제**가 됩니다.

  따라서 카드사 다이렉트 호출시에는 반드시 구매자가 할부 개월수를 선택할 수 있는 UI/UX를 만들어주신 후 결제창 호출(IMP.request\_pay)시 card.direct.quota값을 넘겨야 합니다.

  - 예1. 현대카드 다이렉트 호출 → 무조건 일시불로 결제 됨

    ```json
    {
      "card": {
        "direct": {
          "code": "367"
        }
      }
    }
    ```

  - 예2. 삼성카드 다이렉트 호출 + 5개월 고정 할부 개월수 지정 → 5개월 할부 적용

    ```json
    {
      "card": {
        "direct": {
          "code": "365",
          "quota": 5
        }
      }
    }
    ```
</Details>

<Details>
  <p slot="summary">고정 할부 개월수(card.direct.quota)를 보내도 카드 결제창에서 결제 될 할부 개월수를 확인할 수 없음</p>

  카드사 다이렉트 호출시 quota 값을 보내도 **실제로 카드사 결제창에서는 결제시 적용 될 할부 개월수를 확인할 수 없습니다.** (물론 실제 승인시에는 전달한 quota값 만큼 할부 적용이 됨)

  단, ISP 계열의 카드사인 경우에는 페이북 팝업에서 확인이 가능하며 이 값을 사용자가 변경 할 수는 없습니다.

  - 예. BC카드 다이렉트 호출 + 5개월 고정 할부 개월수 지정\\

    <figure>
      <img src="/gitbook-assets/ko/image (181).png" alt="" />

      <figcaption />
    </figure>

  ```json
  {
    "card": {
      "direct": {
      "code": "361",
      "quota": 5
      }
    }
  }
  ```
</Details>

<Details>
  <p slot="summary">페이북을 통한 ISP 계열 카드 결제시, 카드 번호가 정상적으로 내려오지 않음</p>

  페이북 통한 ISP 계열 카드 결제시 토스페이먼츠로부터 실제 카드 번호와 다른 9200으로 시작하는 카드 번호가 내려오고 있어 결제 승인 내역 조회(POST `/payments/{imp_uid}`)시 응답되는 카드 번호(`card_numer`)가 정확하지 않습니다.
</Details>

<Details>
  <p slot="summary">사파리 브라우저에서 ISP 계열 카드 결제 불가능</p>

  사파리 브라우저에서 ISP 계열 카드 결제를 위한 페이북 팝업 호출에 이슈가 있습니다. 이는 토스페이먼츠 결제창에서 페이북으로 넘어가는 과정에서 발생하는 이슈로 포트원과는 무관합니다.
</Details>

## 가상계좌

<Details>
  <p slot="summary">가상계좌 발급 완료시 예금주 명 알 수 없음</p>

  토스페이먼츠는 가상계좌 발급 완료시 발급 된 가상계좌의 **예금주 명을 전달해주지 않습니다**. 따라서 포트원 REST API로 결제내역 조회(GET `/payments/{imp_uid}`)시 `vbank_holder`가 null로 전달됩니다.

  실제 가상계좌 예금주 명은 토스페이먼츠와 계약된 고객사 이름과 동일하다고 하니, 참고 부탁드립니다.
</Details>

## 간편결제

<Details>
  <p slot="summary">대부분의 간편결제에 대해 결제 테스트 불가능</p>

  토스페이먼츠는 SSGPAY, 네이버페이, 카카오페이, 페이코 등 대부분의 간편결제에 대해 결제 테스트 기능을 제공하고 있지 않습니다. 따라서 테스트용 설정으로 간편결제를 시도하면 `[PAY_PROCESS_ABORTED] Toss Payments와 계약된 결제수단(SSG)이 아닙니다.` 와 같은 에러 메시지가 리턴되면서 결제창이 호출되지 않습니다. 이 경우 토스페이먼츠와 실 상점 계약을 하여 실 상점 정보를 포트원 관리자페이지에 다시 등록한 후 시도하셔야 합니다.
</Details>

<Details>
  <p slot="summary">카드 외 복합 결제 건에 대해서는 정확한 결제 수단 정보 확인 불가능</p>

  간편결제로는 여러가지 결제수단으로 결제 할 수도 있고 각 결제 수단을 혼합하여 복합 결제를 할 수도 있습니다. 이때 토스페이먼츠는 구매자가 정확히 어떤 방식으로 결제했는지 데이터를 내려주지 않으며 그 내용은 아래와 같습니다.

  1. 카드로 결제한 경우에는 카드 정보(카드사, 카드 유형 등)를 확인할 수 있습니다.
  2. 하지만 카드 외의 결제 수단으로 결제를 한 경우에는, 결제 수단 세부 정보(어떤 은행, 포인트, 머니인지)를 확인할 수 없습니다.
  3. 카드가 포함 된 결제 건인지 아닌지는 구분이 됩니다. 따라서 카드가 포함 된 결제 건이면 결제 수단을 `card` 로 기록합니다.
  4. 하지만 계좌 / 포인트 / 머니 중 어떤 것으로 결제 됐는지 구분되지 않습니다. 따라서 카드가 포함 되지 않은 결제 건이면 결제 수단을 `point`로 기록합니다. 실제로 등록된 계좌로 결제 됐다고 하더라도 포인트나 머니로 결제 된 것과 구분되지 않기 때문에 결제 수단을 `trans`로 저장하지 않습니다.
</Details>

<Details>
  <p slot="summary">고정 할부 개월수 적용해도 일시불과 함께 표기</p>

  네이버페이, L페이, 토스페이, 삼성페이 등 일부 간편결제사의 경우 해당 간편결제사의 정책에 따라 **고정 할부 개월수를 설정하더라도 일시불과 함께 렌더링**됩니다.

  - 예. 네이버페이 - 5개월 고정 할부 설정시, 일시불과 5개월 할부 모두 선택 가능

    ```json
    {
      "pay_method": "naverpay",
      "display": {
        "card_quota": [5]
      }
    }
    ```

    <Figure src="/gitbook-assets/ko/image (179).png" alt="" />
</Details>

## 기타

- 상품권 결제는 부분취소가 불가능
- 테스트 결제 건은 매출 전표 확인이 불가능
- 간편결제 - 카드 외의 결제 건은 매출 전표 확인이 불가능
- 간편결제 - L페이 결제창 배경 화면 투명도 이슈로 겹쳐보이는 현상
- `cashReceiptType` 파라미터로 인한 오동작 관련 이슈

<Details>
  <p slot="summary">지출증빙 발급번호 이슈</p>

  `bypass.cashReceiptType`(현금성 결제시, 결제창 내에 현금영수증 발급 유형 설정 값)을 corporate(지출 증빙)으로 설정하고 결제창을 호출하면 토스페이먼츠 결제창에서 현금영수증 발급 유형이 “지출증빙”으로 표기되어있으나 발급 번호가 사업자등록번호가 아닌 주민등록번호로 설정되어있으며 이를 변경할 수 없는 토스 버그가 있습니다. 따라서 구매자는 현금영수증 발급 유형을 지출증빙용이 아닌 소득공제용이나 미발행으로 바꿔서 선택한 후 다시 지출증빙용을 선택해야합니다.

  <img src="/gitbook-assets/ko/image (180).png" alt="" data-size="original" />
</Details>

<Details>
  <p slot="summary">간편결제 - SSG페이 결제시 토스페이먼츠 결제창에서 휴대폰 번호를 입력하지 않아도 다음으로 넘어가는 이슈</p>

  간편결제 - SSG페이 결제시 토스페이먼츠 결제창에서 휴대폰 번호를 입력해야 구매자의 휴대폰에 깔린 SSG 페이 앱에서 푸쉬 알림이 오면서 결제를 할 수 있는데, 현재 토스페이먼츠 결제창에서 휴대폰 번호를 입력하지 않아도 다음 단계로 이동되기 때문에 구매자는 이 경우 무한 대기를 하게 됩니다. 휴대폰 번호를 입력을 하지 않은 경우엔 다음 단계로 이동할 수 없도록 토스 측의 조치가 필요합니다.![](</gitbook-assets/ko/image (188).png>)
</Details>

<Details>
  <p slot="summary">삼성페이 결제 중단시 결제창 잘림 현상</p>

  삼성페이 결제창 렌더링 후 장시간 대기했다가 우측 상단 X 버튼을 눌러 결제 프로세스를 중단하면 아래와 같이 잘린 화면이 렌더링됩니다. 가로 스크롤도 동작하지 않아(스크롤은 움직이지만 화면은 고정) 사용자 경험이 다소 저해됩니다.

  <img src="/gitbook-assets/ko/image (177).png" alt="" data-size="original" />
</Details>

<Details>
  <p slot="summary">현금영수증 발급 API 호출시 유효성 검사를 하지 않음</p>

  예를 들어 현금영수증 발급 유형(type)을 소득공제(person)으로 보내고 현금영수증 발급 번호(identifier)를 사업자 등록번호로 보내면 실제로는 현금영수증 발급에 실패해야하지만 토스페이먼츠에서 유효성 검사를 하지 않아 그대로 성공 응답을 보내고 있습니다.

  따라서 원활한 현금영수증 발급을 위해서는 현금영수증 발급 API 호출시 현금영수증 정보를 정확하게 입력하셔야 합니다.
</Details>

<Details>
  <p slot="summary">사파리 / 파이어폭스 브라우저 내 팝업 블로커 이슈</p>

  사파리 / 파이어폭스 브라우저에서 설정에서 팝업이 차단되어있는 경우 페이북 결제시 팝업이 뜨지 않아 결제 진행이 되지 않거나 가상계좌 발급이나 휴대폰 소액결제시 승인에 실패하는 등 결제가 원활하게 진행되지 않을 수 있으니, 반드시 팝업을 해제하시고 시도해주시기 바랍니다.
</Details>

<Details>
  <p slot="summary">IE 브라우저 - 카드결제 - 페이코 선택시 아래와 같이 결제창이 잘리는 이슈</p>

  이에 대해 토스로부터 “IE 에서 fade out 이 되고 있으므로 수정에 우선순위를 두기 어려울것 같습니다.”라는 답변을 받았습니다.
</Details>

<Details>
  <p slot="summary">IE 브라우저 결제 중단시 에러 메시지 인코딩 이슈</p>

  IE 브라우저에서 결제 중단(결제 승인/실패 이전에 결제창을 명시적으로 닫을때)시 토스페이먼츠로부터 아래와 같이 인코딩 된 에러 메시지가 전달되는 이슈가 있습니다. (이를 디코딩해보면 “사용자가결제를취소하였습니다”라는 메시지)

  `%EC%82%AC%EC%9A%A9%EC%9E%90%EA%B0%80 %EA%B2%B0%EC%A0%9C%EB%A5%BC %EC%B7%A8%EC%86%8C%ED%95%98%EC%98%80%EC%8A%B5%EB%8B%88%EB%8B%A4`

  이에 대해 토스로부터 “IE 의 인코딩 이슈라서 저희가 수정해 드리기가 애매하고, 내부적으로 IE 는 fadeout 되어 더 이상 공식적으로 지원을 하지 않고 있습니다.”라는 답변을 받았습니다.
</Details>

## 토스페이먼츠(구모듈) 연동 가이드

<Hint style="warning">
  **토스페이먼츠(구모듈) 연동 방법에 관한 매뉴얼**입니다.

  신규 연동 고객사이시거나 토스페이먼츠 신모듈로의 업그레이드를 원하신다면 [토스페이먼츠(신모듈) 연동 가이드](#1-토스페이먼츠-채널-설정하기)로 참고하여 진행해주세요.
  구모듈에 비해 신모듈에서 다양한 기능 및 결제수단을 지원하고 있습니다. 신규 고객사의 경우 가급적 신모듈로 연동하는 것을 권장드립니다.
</Hint>

## 1. 토스페이먼츠(구모듈) 채널 설정하기

[결제대행사 채널 설정하기](../../ready/readme#3-결제대행사-채널-설정하기) 페이지의 내용을 참고하여 채널 설정을 진행합니다.

<Figure src="/gitbook-assets/ko/screenshot 2022-05-29 7.38.40.png" />

## 2. 결제창 호출

[JavaScript SDK](../../sdk/javascript-sdk-old/readme) `IMP.request_pay(param, callback)`을 호출하여
토스페이먼츠 결제창을 호출할 수 있습니다.
**결제결과**는 PC의 경우 `IMP.request_pay(param, callback)` 호출 후
<mark style="color:red;">**callback**</mark> 으로 수신되어
모바일의 경우 <mark style="color:red;">**m\_redirect\_url**</mark> 로 리디렉션됩니다.

예시 코드는 아래와 같습니다.

```ts title="Javascript SDK"
IMP.request_pay(
  {
    pg: "uplus.{MID}",
    pay_method: "card",
    merchant_uid: "order_no_0001", //상점에서 생성한 고유 주문번호
    name: "주문명:결제테스트",
    amount: 1004,
    buyer_email: "test@portone.io",
    buyer_name: "구매자이름",
    buyer_tel: "010-1234-5678",
    buyer_addr: "서울특별시 강남구 삼성동",
    buyer_postcode: "123-456",
    m_redirect_url: "{모바일에서 결제 완료 후 리디렉션 될 URL}",
    appCard: true, // 설정시 신용카드 결제모듈에서 앱카드 결제만 활성화됩니다.
  },
  function (rsp) {
    // callback 로직
    //* ...중략... *//
  },
);
```

---

**주요 파라미터 설명**

**`pg` \***<mark style="color:green;">**string**</mark>

**PG사 구분코드**

**`uplus`** 로 지정하면 됩니다.

**`pay_method`** <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>

**결제수단 구분코드**

- card(신용카드)
- trans(실시간 계좌이체)
- vbank(가상계좌)
- phone(휴대폰소액결제)
- applepay(애플페이)
- tosspay(토스페이)
- naverpay(네이버페이)
- kakaopay(카카오페이)
- lpay(엘페이)
- payco(페이코)
- samsung(삼성페이)

**`merchant_uid`** <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>

**주문번호**

매번 고유하게 채번되어야 합니다.

**`amount` \***<mark style="color:purple;">**integer**</mark>

**결제금액**

<mark style="color:green;">**string**</mark> 이 아닌점에 유의하세요

**`escrow`** <mark style="color:orange;">**`boolean`**</mark>

**에스크로 설정여부**

<Codepen user="chaiport" slug="qBxbGXy" caption="토스페이먼츠 결제창 예제" />

## 토스페이먼츠 브랜드페이 연동 가이드

## 1. 토스페이먼츠 브랜드페이 채널 설정하기

[결제대행사 채널 설정하기](../../ready/readme#3-결제대행사-채널-설정하기) 페이지의 내용을 참고하여 채널 설정을 진행합니다.

<Figure src="/gitbook-assets/ko/screenshot 2022-05-29 7.38.40.png" />

## 2. 최신 JavaScript SDK로 업데이트하기

토스페이먼츠 브랜드페이 결제는 최신 SDK에서만 지원되는 기능입니다.

```html title="JS SDK"
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
```

<Hint style="info">
  **토스페이먼츠 브랜드페이를 연동하기 위해서는 위에 안내된 JS SDK를 이용하셔야 합니다**
</Hint>

<Hint style="danger">
  ## **기존에 deprecated된 콜백 응답은 모두 제거**됐습니다.

  신규 JS SDK는 기존 모듈에서 제공했던 CallBack 응답 파라미터가 대부분 삭제되었습니다.
  (특히 deprecated 로 명시된 파라미터는 모두 삭제되었습니다.)

  해당 JS SDK 사용시 Callback 으로 내려받을수 있는 데이터는 오직 아래 두가지 입니다.

  **`imp_uid`, `merchant_uid`**

  따라서 해당 SDK를 사용하실때는 `IMP.request_pay`로부터 응답된 객체(또는 쿼리 파라미터)에서
  `imp_uid`를 가지고 **아임포트 REST API(GET `/payments/imp_uid`)로 결제 상세 내역(승인 상태, 승인 결과 등등)을 조회**하여
  응답 파라미터 중 `status` 파라미터로 결제 상태를 파악하셔야 합니다.
</Hint>

[JavaScript SDK](../../sdk/javascript-sdk/readme) 문서를 통해 최신 SDK를 설치해주세요.

## 3. 결제 요청하기

- [JavaScript SDK](../../sdk/javascript-sdk/readme) `IMP.request_pay(param, callback)`을 호출하여
  브랜드페이 결제창을 호출할 수 있습니다.

- **결제 결과**는 PC 환경과 모바일 환경 모두 <mark style="color:red;">**callback**</mark>으로
  수신됩니다.

<Tabs>
  <Tab title="인증결제창 요청">
    ```ts title="Javascript SDK"
    IMP.request_pay(
      {
        pg: "toss_brandpay.{상점 ID}",
        pay_method: "toss_brandpay",
        merchant_uid: "orderNo0001",
        name: "주문명:결제테스트",
        amount: 1004,
        buyer_email: "test@portone.io",
        customer_id: "d005f081-830a-4b9c-b5e2-73e56fbe6ac3",
        bypass: {
          isCulturalExpense: true,
        },
      },
      function (rsp) {
        // callback 로직
      },
    );
    ```

    <Details>
      <p slot="summary"><strong>주요 파라미터 설명</strong></p>

      **`pg`** <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>

      **PG사 구분코드**

      `toss_brandpay` 로 지정하면 됩니다.

      **`pay_method`** <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>

      **결제수단 구분코드**

      `toss_brandpay` 로 지정하면 됩니다.

      **`merchant_uid`** <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>

      **주문번호**

      매번 고유하게 채번되어야 합니다.

      **`name`** <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>

      **주문명**

      **`amount`** <mark style="color:red;">**\***</mark> <mark style="color:green;">**integer**</mark>

      **결제금액**

      브랜드페이는 원화 결제만 지원합니다. KRW 기준으로 금액을 입력해주세요.

      **`buyer_email`** <mark style="color:green;">**string**</mark>

      **구매자 email 주소**

      **`customer_id`** <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>

      **구매자 ID**

      고객 ID입니다. 다른사용자에게 노출될 경우, 악의적 사용에 대한 문제가 있음으로 자동 증가하는 숫자는 허용되지 않습니다.\
      UUID 등 유추가 불가능한 무작위 값을 사용하시길 권장드립니다.

      **`bypass.isCulturalExpense`** <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>

      **도서 문화비 결제 여부**

      도서 문화비 소득 공제 결제 여부를 나타내는 파라미터입니다. 기본값은 `false`입니다.
    </Details>
  </Tab>
</Tabs>

## 3. UI 커스터마이징

- 브랜드페이의 경우 결제창의 UI를 커스터마이징이 가능하며, 아래의 옵션들을 제공하고 있습니다.

- 포트원을 통한 연동 후 `IMP.request_pay` 호출 시 `bypass.toss_brandpay.ui` 객체 정보를 추가하여 UI
  커스터마이징 기능을 사용할 수 있습니다.

<Tabs>
  <Tab title="UI 커스터마이징">
    ```ts title="Javascript SDK"
    IMP.request_pay(
      {
        pg: "toss_brandpay.{상점 ID}",
        pay_method: "toss_brandpay",
        merchant_uid: "orderNo0001",
        name: "주문명:결제테스트",
        amount: 1004,
        buyer_email: "test@portone.io",
        bypass: {
          toss_brandpay: {
            brandpayOptions: {
              ui: {
                buttonStyle: "default",
                highlightColor: "#3182f6",
                navigationBar: {
                  visible: true,
                  paddingTop: 10,
                },
                labels: {
                  oneTouchPay: "원터치결제",
                },
              },
            },
          },
        },
      },
      function (rsp) {
        // callback 로직
      },
    );
    ```

    **`buttonStyle`** <mark style="color:green;">**string**</mark>

    **버튼스타일 구분코드**

    - 버튼 스타일입니다. 값을 넣지 않으면 기본값인 `default`로 설정됩니다.
    - `default`로 설정하면 모서리가 둥글고 주변에 여백을 가진 버튼을 사용할 수 있고, `full`로 설정하면 하단 영역이 전부 채워지는 형태의 버튼을 사용할 수 있습니다.

    **`highlightColor`** <mark style="color:green;">**string**</mark>

    **UI 메인 색상**

    - UI의 메인 색상입니다.
    - 값을 넣지 않으면 기본 색상인 `#3182f6`로 설정됩니다.
    - [웹에서 사용할 수 있는 색상 코드 형식](https://developer.mozilla.org/ko/docs/Web/CSS/color_value)을 모두 사용할 수 있습니다.

    **`navigationBar.visible`** <mark style="color:green;">**boolean**</mark>

    **내비게이션 바 사용 여부**

    - 화면 뒤로 가기 기능을 제공하는 내비게이션 바 사용 여부입니다.
    - 값을 넣지 않으면 기본값인 `true`로 설정됩니다.
    - 내비게이션 바를 사용하지 않으려면 `false`로 설정해야 합니다.

    **`navigationBar.paddingTop`** <mark style="color:green;">**number**</mark>

    **내비게이션 바 상단 여백**

    - 내비게이션 바 위쪽에 설정할 여백 값입니다. 값의 단위는 `px`입니다.

    **`labels.oneTouchPay`** <mark style="color:green;">**string**</mark>

    **원터치결제 대체 텍스트**

    - UI에 표시되는 `원터치결제`를 대신해 사용할 텍스트입니다. 값을 넣지 않으면 `원터치결제`로 표시됩니다.
  </Tab>
</Tabs>

## 4. 결제수단 지정 바로 결제

- 브랜드페이에 등록된 각 결제수단은 `methodId`라는 결제 수단 ID가 맵핑됩니다.

- 결제창 호출 시 `methodId` 중 하나를 지정하는 경우 UI에서 결제수단을 선택하지 않고 해당
  결제수단으로 바로 결제를 할 수 있습니다.

- `methodId`는 [`IMP.loadModule()`](#토스페이먼츠-브랜드페이-모듈-로딩-연동)을 호출 후 사용할 수
  있는, `getPaymentMethods()` 함수를 통해 확인할 수 있습니다.

<Tabs>
  <Tab title="바로 결제">
    ```ts title="Javascript SDK"
    IMP.request_pay(
      {
        pg: "toss_brandpay.{상점 ID}",
        pay_method: "toss_brandpay",
        merchant_uid: "orderNo0001",
        name: "주문명:결제테스트",
        amount: 1004,
        buyer_email: "test@portone.io",
        customer_id: "d005f081-830a-4b9c-b5e2-73e56fbe6ac3",
        useCardPoint: true,
        display: {
          card_quota: [6],
        },
        bypass: {
          cashReceiptType: "personal",
          customerIdentifier: "01000000000",
          toss_brandpay: {
            methodId: "3nKLoSBV7l8zUHU14cZxK",
            discountCode: "001",
          },
        },
      },
      function (rsp) {
        // callback 로직
      },
    );
    ```

    ### 기타 파라미터

    아래 파라미터를 사용하기 위해서는 결제 수단 ID인 `methodId`를 지정하여 함께 결제 요청해야 합니다.

    <Hint style="danger">
      #### **브랜드페이 위젯에서 사용할 수 없는 파라미터** 가 포함되어 있습니다.

      아래 파라미터는 브랜드페이 위젯에서는 사용할 수 없습니다.

      - **`display.card_quot`**
      - **`useCardPoint`**
      - **`bypass.cashReceiptType`**
      - **`bypass.customerIdentifier`**
    </Hint>

    **`useCardPoint`** <mark style="color:green;">**boolean**</mark>

    **카드사 포인트 사용 여부**

    - 카드사 포인트를 사용 여부를 지정하는 값입니다.
    - `true` 입력 시 카드사 포인트 사용이 가능하며, 입력하지 않는 경우 기본값은 `false`입니다.
    - (단, 카드사 포인트를 사용하기 위해서는 사전에 토스페이먼츠를 통해 계약이 진행되어야 합니다.)

    **`display.card_quota`** <mark style="color:green;">**number array**</mark>

    **카드 할부 개월 수**

    - 카드 결제 시 할부 개월 수를 지정할 수 있습니다.
    - `[3]` 형식으로 전달하면 3개월 할부로 결제가 진행됩니다.
    - (단, 일반적으로 결제금액이 5만원 이상일 때만 적용됩니다.)

    **`bypass.cashReceiptType`** <mark style="color:green;">**string**</mark>

    **현금영수증 발급 타입**

    - `unable`로 설정시 현금영수증을 발행하지 않으며, `personal`로 설정 시에는 소득 공제용, `corporate`으로 설정 시에는 지출 증빙용으로 현금영수증을 발급합니다.
    - `anonymous`으로 설정하는 경우 현금영수증 자진발급됩니다. 기본값은 `unable`입니다.

    **`bypass.customerIdentifier`** <mark style="color:green;">**string**</mark>

    **현금영수증 발급 식별번호**

    - 현금영수증 발급을 위한 식별번호입니다.
    - 현금영수증 종류에 따라 휴대폰번호, 사업자등록번호, 현금영수증 카드번호를 입력할 수 있습니다.

    **`bypass.toss_brandpay.discountCode`** <mark style="color:green;">**string**</mark>

    **카드사 즉시 할인 코드**

    - 토스페이먼츠의 [카드혜택 조회 API](https://docs.tosspayments.com/reference#%EC%B9%B4%EB%93%9C-%ED%98%9C%ED%83%9D-%EC%A1%B0%ED%9A%8C-1)로 적용할 수 있는 할인 코드 목록을 조회할 수 있습니다.
    - 해당 API는 포트원을 통해 지원이 불가능하므로, 직접 토스페이먼츠 API를 연동하여 사용해야 합니다.

    ### 브랜드페이 위젯 전용 파라미터

    아래 파라미터를 사용하기 위해서는 결제 수단 ID인 `methodId`를 지정하여 함께 결제 요청해야 합니다.

    <Hint style="info">
      #### 브랜드페이 위젯에서만 사용 가능한 파라미터입니다.

      `bypass.toss_brandpay.widgetOptions` 에 설정되어야 합니다.
    </Hint>

    **`methodType`** <mark style="color:green;">**string**</mark>

    **위젯에 보여줄 결제 수단**

    - 위젯에 보여줄 결제수단을 선택합니다.
    - `카드`, `계좌` 중 하나입니다. 예를 들어 `카드`를 선택하면 등록한 결제수단 중 `카드`만 노출됩니다.

    **`methodId`** <mark style="color:green;">**string**</mark>

    **위젯에서 기본 결제수단으로 선택할 결제수단의 ID**

    - 위젯을 열었을때, 해당 methodId에 해당하는 결제수단이 가장 먼저 보여집니다.
    - 가장 최근에 결제한 카드를 보여주거나, 유저가 선호하는 카드를 보여줄 때 사용할 수 있습니다.

    **`ui.promotionSection.summary.visible`** <mark style="color:green;">**boolean**</mark>

    **혜택 배지 영역 표시여부**

    - 해택 배지 영역에서는 즉시 할인 대상 카드 정보 등을 간략히 보여줍니다. 기본값은 `true`입니다.

    **`ui.promotionSection.description.visible`** <mark style="color:green;">**boolean**</mark>

    **혜택 배지 영역 표시여부**

    - 결제 해택 영역을 보여주거나 숨깁니다. 기본값은 `true`입니다.

    **`ui.promotionSection.description.defaultOpen`** <mark style="color:green;">**boolean**</mark>

    **결제 혜택 상세 설명 표시 여부**

    - 결제 혜택의 상세 설명을 보여주거나 숨깁니다.
    - `true`인 경우, 결제 카드사의 결제 혜택을 자세히 설명합니다. 기본값은 `false`입니다.
  </Tab>
</Tabs>

## 토스페이먼츠 브랜드페이 위젯 연동

- 브랜드페이의 경우 고객사의 주문 페이지에 바로 브랜드페이를 통한 결제가 가능하도록 브랜드페이 UI를
  렌더링 할 수 있는 위젯 기능을 제공합니다.

- 위젯 기능을 연동하기 위해서는 일반적으로 포트원 SDK에서 사용하던 함수가 아닌 `IMP.loadUI` 함수와
  `IMP.updateLoadUIRequest` 함수를 사용해야 합니다.

<Figure src={screenshot1} />

## 브랜드페이 위젯 렌더링

- 브랜드페이 위젯은 고객사 체크아웃 페이지에 결제수단 선택 UI를 렌더링 한 후, 결제버튼 클릭시
  브랜드페이로 결제를 하는 방식입니다.

- 따라서 다른 PG사와 결제 플로우가 상이하기 때문에 고객사는 **체크아웃 페이지가 렌더링 되는 시점에
  `IMP.request_pay` 함수 대신 `IMP.loadUI`라는 별도의 함수를 호출해 위젯을 렌더링 해야**합니다.

<Figure src={screenshot2} />

```html
<!--
  1. 고객사 체크아웃 페이지가 렌더링됩니다.
  브랜드페이 위젯을 렌더링 하고 싶은 위치에 "portone-ui-container"라는 class 이름을 갖는 div element를 넣습니다.
  data-portone-ui-type는 브랜드페이 위젯용임을 나타내는 toss-brandpay-widget로 설정합니다.
  결제하기 버튼 역할을 하는 element의 경우 id를 "portone-toss-brandpay-widget-button"로 설정해야 합니다.
  포트원 SDK는 해당 id를 가지는 element를 찾아 결제하기 event를 등록합니다.
-->
<div class="portone-ui-container" data-portone-ui-type="toss-brandpay-widget">
  <!-- 3. 여기에 결제수단 위젯이 생성됩니다. -->
</div>

<div id="portone-toss-brandpay-widget-button">
  <!-- 1-1. 결제하기 버튼 구현 -->
</div>

<script>
  window.onload = function () {
    // 2. 고객사 체크아웃 페이지가 렌더링 되면
    // 2-1. "고객사 식별코드"를 전달해 포트원 객체를 초기화합니다.
    IMP.init(고객사_식별코드);

    // 2-2. "결제 요청 데이터"와 결제 프로세스가 종료되면 호출 될 "콜백 함수"를 전달하여 브랜드페이 위젯 렌더링을 시도합니다.
    // 이때 전달하는 파라미터는 IMP.request_pay 함수 호출시 전달하는 파라미터와 동일합니다.
    IMP.loadUI("toss-brandpay-widget", 결제_요청_데이터, 콜백_함수);

    // 4. 구매자가 결제하기 버튼을 누르면 PG사 결제창이 렌더링 됩니다.
    // 5. 이때 포트원은 내부적으로 IMP.request_pay 함수를 고객사 대신 호출합니다.
    // 6-7. 포트원 DB에 미결제(ready) 결제 건이 생성됩니다.
    // 8. PG사 결제창이 호출됩니다.
    // 9. 결제 프로세스가 종료되면 2-2번에 두번째 파라미터로 전달 한 콜백 함수가 호출됩니다.
  };
</script>
```

<Hint style="info">
  ### 위젯이 렌더링 되지 않을 때

  <mark style="color:red;">`portone-ui-container`</mark> 라는 class 이름을 갖는 div
  element를 찾지 못할 경우 **portone-ui-container를 찾을 수 없습니다.** 라는 에러가
  발생합니다.

  <mark style="color:red;">`portone-ui-container`</mark> element가 2개 이상인데, `data-portone-ui-type`
  attribute가 `toss-brandpay-widget`인 element를 찾지 못할 경우, **data-portone-ui-type에
  올바른 UI 타입을 입력해주세요.** 라는 에러가 발생합니다.

  <mark style="color:red;">`portone-ui-container`</mark> element가 2개 이상이고, `data-portone-ui-type`
  attribute가 `oss-brandpay-widget`인 elemente도 2개 이상인 경우, **동일한 data-portone-ui-type을
  갖는 DOM element가 2개 이상 존재합니다.** 라는 에러가 발생합니다.
</Hint>

## 결제 요청 데이터 업데이트

- 브랜드페이의 특성상, 고객사 체크아웃 페이지가 렌더링 될 때 결제 요청 데이터가 결정 되어야 합니다.
  때문에 고객사 체크아웃 페이지에서 포인트나 쿠폰을 적용 해 결제 금액이 바뀌는 경우에 이를 다시
  업데이트 할 수 있는 방법이 제공돼야 합니다.

- 포트원 SDK는 위와 같은 경우에 대응하기 위해 결제 정보를 업데이트 할 수 있는
  `IMP.updateLoadUIRequest` 함수를 제공하고 있습니다.  구매자 입력으로 인해 결제 요청 데이터가
  변경될때 **IMP.updateLoadUIRequest 함수를 호출**하시면 구매자가 결제 버튼을 누를때 최종적으로 변경
  된 결제 요청 데이터로 브랜드페이 결제창이 호출됩니다.

<Figure src={screenshot3} />

```html
<form>
  <!-- 결제 요청 데이터를 입력 받는 form -->
  <!-- ...중략 -->
  <label for="amount">결제 금액</label>
  <!-- 4. 구매자가 쿠폰을 적용해 결제 요청 금액이 변경(예) 1000 -> 2000)되었습니다. -->
  <input id="amount" name="amount" value="1000" onchnage="onChangeAmount()" />
</form>

<!--
  1. 고객사 체크아웃 페이지가 렌더링됩니다.
  브랜드페이 위젯을 렌더링 하고 싶은 위치에 "portone-ui-container"라는 class 이름을 갖는 div element를 넣습니다.
  data-portone-ui-type는 브랜드페이 위젯용임을 나타내는 toss-brandpay-widget로 설정합니다.
  결제하기 버튼 역할을 하는 element의 경우 id를 "portone-toss-brandpay-widget-button"로 설정해야 합니다.
  포트원 SDK는 해당 id를 가지는 element를 찾아 결제하기 event를 등록합니다.
-->
<div class="portone-ui-container" data-portone-ui-type="toss-brandpay-widget">
  <!-- 3. 여기에 결제수단 위젯이 생성됩니다. -->
</div>

<div id="portone-toss-brandpay-widget-button">
  <!-- 1-1. 결제하기 버튼 구현 -->
</div>

<script>
  var requestData = {
    pg: "toss_brandpay",
    amount: 1000,
    // ...중략
  };
  window.onload = function () {
    // 2. 고객사 체크아웃 페이지가 렌더링 되면
    // 2-1. "고객사 식별코드"를 전달 해 포트원 객체를 초기화합니다.
    IMP.init(고객사_식별코드);

    // 2-2. "결제 요청 데이터"와 결제 프로세스가 종료되면 호출 될 "콜백 함수"를 전달하여 브랜드페이 위젯 렌더링을 시도합니다.
    // 이때 전달하는 파라미터는 IMP.request_pay 함수 호출시 전달하는 파라미터와 동일합니다.
    IMP.loadUI("toss-brandpay-widget", requestData, 콜백_함수);

    // 6. 구매자가 결제하기 버튼을 누르면 PG사 결제창이 렌더링 됩니다.
    // 7. 이떄 포트원은 내부적으로 IMP.request_pay 함수를 고객사 대신 호출하며
    // 결제 요청 금액은 1000에서 2000으로 변경됩니다.

    // 8-9. 포트원 DB에 미결제(ready) 결제 건이 생성됩니다.
    // 10. PG사 결제창이 호출됩니다.
    // 11. 결제 프로세스가 종료되면 2-2번에 두번째 파라미터로 전달 한 콜백 함수가 호출됩니다.
  };

  function onChangeAmount() {
    // 5. 결제 요청 금액이 변경되면 고객사가 선언한 onChangeAmount 함수가 호출됩니다.
    // IMP.updateLoadUIRequest에 최종적으로 변경 된 결제 요청 데이터를 전달합니다.
    requestData.amount = document.getElementById("amount").value;
    IMP.updateLoadUIRequest("toss-brandpay-widget", requestData);
  }
</script>
```

## loadUI 요청 객체

loadUI 호출시 파라미터인 결제요청 데이터의 경우 IMP.request\_pay의 요청데이터와 동일한 객체이므로, [브랜드페이 연동문서](#토스페이먼츠-브랜드페이-연동-가이드)를
참고해주세요.

## 토스페이먼츠 브랜드페이 모듈 로딩 연동

## 모듈 로드 파라미터 정의

<Tabs>
  <Tab title="모듈 로드 요청">
    ```ts title="Javascript SDK"
    await IMP.loadModule(
      "toss-brandpay",
      {
        userCode: "imp00000000", //// 관리자 콘솔 - 결제 연동 페이지에서 확인 가능합니다.
      },
      {
        customerKey: "d005f081-830a-4b9c-b5e2-73e56fbe6ac3",
        loadBrandpayOptions: {
          ui: {
            buttonStyle: "default",
            highlightColor: "#3182f6",
            navigationBar: {
              visible: true,
              paddingTop: 10,
            },
            labels: {
              oneTouchPay: "원터치결제",
            },
          },
        },
      },
    );
    ```

    <Details>
      <p slot="summary"><strong>주요 파라미터 설명</strong></p>

      **`moduleType`** <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>

      **모듈 타입**

      브랜드페이의 경우 `toss-brandpay` 를 사용합니다.

      **`userCode`** <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>

      **고객사 식별코드**

      `IMP` 로 시작하는 포트원 고객사 식별코드입니다.

      **`tier_code`** <mark style="color:green;">**string**</mark>

      **하위상점(Tier)의 고유코드**

      \[상점·계정 관리]-\[하위 상점 관리]에서 하위 상점을 생성한 경우에만 사용 가능합니다. 하위상점 고유코드는 알파벳 대문자 또는 숫자만 입력가능하며, 3자까지 입력 가능합니다.

      **`loadBrandpayOptions`** <mark style="color:green;">**Object**</mark>

      브랜드페이의 모듈 로딩에 필요한 추가 파라미터입니다.
      `moduleType`을 `toss-brandpay`로 설정하는 경우 필요합니다.

      **`loadBrandpayOptions.customer_id`** <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>

      **구매자 ID**

      고객 ID입니다. 다른사용자에게 노출될 경우, 악의적 사용에 대한 문제가 있음으로 자동 증가하는 숫자는 허용되지 않습니다.
      UUID 등 유추가 불가능한 무작위 값을 사용하시길 권장드립니다.

      **`loadBrandpayOptions.ui`** <mark style="color:green;">**Object**</mark>

      브랜드페이의 경우 결제창의 UI를 커스터마이징이 가능하며, 아래의 옵션들을 제공하고 있습니다.
      포트원을 통한 연동 후 `IMP.request_pay` 호출 시 `bypass.toss_brandpay.ui` 객체 정보를 추가하여 UI 커스터마이징 기능을 사용할 수 있습니다.

      **`loadBrandpayOptions.ui.buttonStyle`** <mark style="color:green;">**string**</mark>

      **버튼스타일 구분코드**

      버튼 스타일입니다. 값을 넣지 않으면 기본값인 `default`로 설정됩니다.
      `default`로 설정하면 모서리가 둥글고 주변에 여백을 가진 버튼을 사용할 수 있고, `full`로 설정하면 하단 영역이 전부 채워지는 형태의 버튼을 사용할 수 있습니다.

      **`loadBrandpayOptions.ui.highlightColor`** <mark style="color:green;">**string**</mark>

      **UI 메인 색상**

      UI의 메인 색상입니다. 값을 넣지 않으면 기본 색상인 `#3182f6`로 설정됩니다. [웹에서 사용할 수 있는 색상 코드 형식](https://developer.mozilla.org/ko/docs/Web/CSS/color_value)을 모두 사용할 수 있습니다.

      **`loadBrandpayOptions.ui.navigationBar.visible`** <mark style="color:green;">**boolean**</mark>

      **내비게이션 바 사용 여부**

      화면 뒤로 가기 기능을 제공하는 내비게이션 바 사용 여부입니다. 값을 넣지 않으면 기본값인 `true`로 설정됩니다. 내비게이션 바를 사용하지 않으려면 `false`로 설정해야 합니다.

      **`loadBrandpayOptions.ui.navigationBar.paddingTop`** <mark style="color:green;">**number**</mark>

      **내비게이션 바 상단 여백**

      내비게이션 바 위쪽에 설정할 여백 값입니다. 값의 단위는 `px`입니다.

      **`loadBrandpayOptions.ui.labels.oneTouchPay`** <mark style="color:green;">**string**</mark>

      **원터치결제 대체 텍스트**

      UI에 표시되는 `원터치결제`를 대신해 사용할 텍스트입니다. 값을 넣지 않으면 `원터치결제`로 표시됩니다.
    </Details>
  </Tab>
</Tabs>

## 모듈로드 결과값 정의

<Tabs>
  <Tab title="모듈 로드 요청">
    ```ts title="Javascript SDK"
    const brandpayModule = await IMP.loadModule(
      "toss-brandpay",
      {
        userCode: "imp00000000", //// 관리자 콘솔 - 결제 연동 페이지에서 확인 가능합니다.
      },
      {
        customerKey: "d005f081-830a-4b9c-b5e2-73e56fbe6ac3",
        loadBrandpayOptions: {
          ui: {
            buttonStyle: "default",
            highlightColor: "#3182f6",
            navigationBar: {
              visible: true,
              paddingTop: 10,
            },
            labels: {
              oneTouchPay: "원터치결제",
            },
          },
        },
      },
    );

    brandpayModule.setupPassword();
    brandpayModule.getPaymentMethods();
    brandpayModule.openSettings();
    ```
  </Tab>

  <Details>
    <p slot="summary"><strong>setupPassword 설명</strong></p>

    결제할 때 사용할 비밀번호를 설정할 수 있는 메서드입니다. 비밀번호 등록・변경이 완료되면 Promise가 resolve됩니다.

    자세한 내용은 [토스페이먼츠의 개발자센터 문서](https://docs.tosspayments.com/reference/brandpay-sdk#setuppassword) 를 참고하세요.

    ```ts title="Javascript SDK"
    brandpayModule.setupPassword().catch(function (error) {
      if (error.code === "USER_CANCEL") {
        // 사용자가 창을 닫아 취소한 경우에 대한 처리
      }
    });
    ```
  </Details>

  <Details>
    <p slot="summary"><strong>getPaymentMethods 설명</strong></p>

    등록되어 있는 결제 수단을 조회하는 메서드입니다. 조회가 성공했을 때 Promise가 resolve되고 고객의 결제수단 정보(BrandpayMethodResponse)가 반환됩니다.

    자세한 내용은 [토스페이먼츠의 개발자센터 문서](https://docs.tosspayments.com/reference/brandpay-sdk#getpaymentmethods) 를 참고하세요.

    ```ts title="Javascript SDK"
    brandpayModule
      .getPaymentMethods()
      .then(function (methods) {
        // 성공 처리
      })
      .catch(function (error) {
        if (error.code === "USER_CANCEL") {
          // 사용자가 결제창을 닫은 경우 에러 처리
        }
      });
    ```
  </Details>

  <Details>
    <p slot="summary"><strong>openSettings 설명</strong></p>

    브랜드페이에서 사용하는 결제수단, 비밀번호 설정을 관리하는 결제 관리창을 열 수 있습니다.

    자세한 내용은 [토스페이먼츠의 개발자센터 문서](https://docs.tosspayments.com/reference/brandpay-sdk#opensettings) 를 참고하세요.

    ```ts title="Javascript SDK"
    brandpayModule.openSettings().catch(function (error) {
      if (error.code === "USER_CANCEL") {
        // 사용자가 창을 닫아 취소한 경우에 대한 처리
      }
    });
    ```
  </Details>
</Tabs>

## 토스페이먼츠 브랜드페이 연동 유의사항

## 카드 결제

### 고정 할부 개월 수 결제

- 포트원을 통해 다른 결제대행사(PG)를 이용하는 경우 `display.card_quota` 파라미터에 할부 개월 수를
  입력하여 결제 요청을 하면, 구매자에게 노출할 할부 개월 수 정보를 리스트로 제어가 가능합니다.

- 하지만 포트원을 통해 브랜드페이를 이용하는 경우 해당 파라미터 값을 입력 후 결제 요청 시 입력한
  할부 개월 수로 결제가 진행됩니다.

<Details>
  <p slot="summary">파라미터 사용 예시</p>

  - 예1. 6개월 할부로 결제를 하고자 하는 경우

  ```json
  {
    "display": {
      "card_quota": [6]
    },
    "bypass": {
      "toss_brandpay": {
        "methodId": "c_j429K3djbS01dlk" // 브랜드페이에 등록된 결제 수단의 ID
      }
    }
  }
  ```
</Details>

## 현금영수증 유의사항

### 소득공제용 자진발급

- 결제창 내에서 현금영수증 미발행을 선택한 후 결제 승인이 되면 현금영수증이 소득공제용 자진발급으로
  발급됩니다.

- 브랜드페이 결제 요청 시 `methodId` 와 함께 `bypass.cashReceiptType`을 `anonymous`로 입력한 후 결제
  요청 및 승인이 완료되면 현금영수증이 소득공제용 자진발급으로 발급됩니다.

<Details>
  <p slot="summary">파라미터 사용 예시</p>

  ```json
  {
    "bypass": {
      "cashReceiptType": "anonymous",
      "toss_brandpay": {
        "methodId": "c_j429K3djbS01dlk" // 브랜드페이에 등록된 결제 수단의 ID
      }
    }
  }
  ```
</Details>

## 취소관련 유의사항

### 잔여 면세금액 계산

- 부분 취소 및 전체 취소시, 남은 면세 금액을 정확하게 계산하여 요청해야합니다.

## 테스트 관련 유의사항

### 더미 데이터 리턴

- 브랜드페이의 경우 토스페이먼츠의 정책상 테스트 환경의 API 키를 이용하여 결제 요청 및 승인을 하면 더미 데이터 값이 리턴됩니다.
- 연동 후 정상적인 데이터를 확인하기 위해서는 브랜드페이의 라이브 API 키를 이용해서 결제 요청 및 승인을 진행해야 합니다.

### 토스페이먼츠 제공 API 사용

- 결제 취소를 제외한 현금영수증 발급 API 및 결제조회 API는 토스페이먼츠에서 제공하는 API를 이용해야 합니다.
